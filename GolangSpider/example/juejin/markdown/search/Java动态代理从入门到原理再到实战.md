# JavaåŠ¨æ€ä»£ç†ä»å…¥é—¨åˆ°åŸç†å†åˆ°å®æˆ˜ #

## ç›®å½• ##

* å‰è¨€
* ä»€ä¹ˆæ˜¯åŠ¨æ€ä»£ç†ï¼Œå’Œé™æ€ä»£ç†æœ‰ä»€ä¹ˆåŒºåˆ«
* JavaåŠ¨æ€ä»£ç†çš„ç®€å•ä½¿ç”¨
* JavaåŠ¨æ€ä»£ç†çš„åŸç†è§£è¯»
* åŠ¨æ€ä»£ç†åœ¨Androidä¸­çš„ä½¿ç”¨

##å‰è¨€ ç›¸ä¿¡åŠ¨æ€ä»£ç†è¿™ä¸ªè¯å¯¹äºå¾ˆå¤šAndroidå¼€å‘çš„å°ä¼™ä¼´æ¥è¯´æ—¢ç†Ÿæ‚‰åˆé™Œç”Ÿï¼Œç†Ÿæ‚‰æ˜¯åº”ä¸ºå¯èƒ½å¸¸å¸¸ä¼šå¬ä¸€äº›ç¾¤é‡Œï¼Œåšå®¢ä¸Šçš„è£…Bèƒ½æ‰‹æŒ‚åœ¨å˜´è¾¹ï¼Œé™Œç”Ÿæ˜¯å› ä¸ºåœ¨æ—¥å¸¸çš„Androidå¼€å‘ä¸­ä¼¼ä¹æ²¡æœ‰ç”¨åˆ°è¿‡è¿™ä¸ªä¸œè¥¿ï¼Œä¹Ÿæ²¡æœ‰è‡ªå·±å»å­¦è¿‡è¿™ä¸ªä¸œè¥¿ï¼ˆç‰¹åˆ«æ˜¯åŸ¹è®­ç­å‡ºæ¥çš„å°ä¼™ä¼´ä»¬ï¼Œæ®æˆ‘è¯´çŸ¥å¤§éƒ¨åˆ†AndroidåŸ¹è®­ç­æ˜¯ä¸ä¼šè¯´è¿™ä¸œè¥¿çš„ï¼Œå°‘éƒ¨åˆ†ä¹Ÿåªæ˜¯ç®€å•æä¸€ä¸‹å°±ç•¥è¿‡äº†ï¼‰ã€‚è€Œè¿™ç§ç†Ÿæ‚‰åˆé™Œç”Ÿçš„æ„Ÿè§‰è®©æŸäº›å°ä¼™ä¼´è§‰å¾—åŠ¨æ€ä»£ç†å¾ˆé«˜çº§ï¼Œæ˜¯é‚£äº›å¤§ä½¬ä»¬æ‰ç”¨çš„çŸ¥è¯†ã€‚è€Œæˆ‘ï¼Œä»Šå¤©å°±å¸®åŠ©å°ä¼™ä¼´ä»¬æŠŠåŠ¨æ€ä»£ç†æ‹‰ä¸‹ç¥å›ï¼Œä¸‹æ¬¡å†æœ‰è£…é€¼å°èƒ½æ‰‹å’Œä½ è¯´åŠ¨æ€ä»£ç†çš„æ—¶å€™ä½ å°±æ•²ç€ä»–çš„è„‘è¢‹è¯´Lï¼ˆè€ï¼‰Zï¼ˆå­ï¼‰ä¹Ÿä¼šğŸ˜ã€‚

## ä»€ä¹ˆæ˜¯åŠ¨æ€ä»£ç†ï¼Œå’Œé™æ€ä»£ç†æœ‰ä»€ä¹ˆåŒºåˆ« ##

åŠ¨æ€ä»£ç†å’Œé™æ€ä»£ç†å…¶å®éƒ½å¯ä»¥çœ‹æˆæ˜¯å¯¹ä»£ç†æ¨¡å¼çš„ä¸€ä¸ªä½¿ç”¨ï¼Œä»€ä¹ˆæ˜¯ä»£ç†æ¨¡å¼å‘¢ï¼Ÿ

> 
> 
> 
> ç»™æŸä¸ªå¯¹è±¡æä¾›ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œå¹¶ç”±ä»£ç†å¯¹è±¡æä¾›å’Œæ§åˆ¶å¯¹åŸå¯¹è±¡çš„è®¿é—®ã€‚
> ä»£ç†æ¨¡å¼å…¶å®æ˜¯ä¸€ä¸ªå¾ˆç®€å•çš„è®¾è®¡æ¨¡å¼ï¼Œå…·ä½“çš„ç»†èŠ‚å°ä¼™ä¼´ä»¬å¯ä»¥è‡ªå·±ç™¾åº¦ï¼Œè¿™é‡Œå°±ä¸å¤šåšä»‹ç»ã€‚
> 
> 

é™æ€ä»£ç†ä¸­ï¼Œéœ€è¦ä¸ºè¢«ä»£ç†çš„ç±»ï¼ˆå§”æ‰˜ç±»ï¼‰æ‰‹åŠ¨ç¼–å†™ä¸€ä¸ªä»£ç†ç±»ï¼Œä¸ºéœ€è¦è¢«ä»£ç†çš„æ¯ä¸€ä¸ªæ–¹æ³•éƒ½å†™ä¸€ä¸ªæ–°çš„æ–¹æ³•ï¼Œè¿™éƒ¨åˆ†åœ¨ç¼–è¯‘ä¹‹å‰å°±éœ€è¦å®Œæˆäº†ã€‚è€ŒåŠ¨æ€ä»£ç†åˆ™æ˜¯å¯ä»¥åœ¨è¿è¡Œä¸­åŠ¨æ€ç”Ÿæˆä¸€ä¸ªä»£ç†ç±»ï¼Œå¹¶ä¸”ä¸éœ€è¦å»æ‰‹åŠ¨çš„å®ç°æ¯ä¸ªè¢«ä»£ç†çš„æ–¹æ³•ã€‚ç®€å•æ¥è¯´å§”æ‰˜ç±»ä¸­æœ‰1000ä¸ªæ–¹æ³•éœ€è¦è¢«ä»£ç†ï¼ˆæ¯”å¦‚ä»£ç†çš„ç›®çš„å°±æ˜¯å¤§å®¶å¸¸å¸¸ç”¨æ¥ä¸¾ä¾‹çš„åœ¨æ¯ä¸ªæ–¹æ³•æ‰§è¡Œå‰åé¢å¤–æ‰“å°ä¸€æ®µè¾“å‡ºï¼‰ï¼Œä½¿ç”¨é™æ€ä»£ç†ä½ éœ€è¦æ‰‹åŠ¨çš„ç¼–å†™ä»£ç†ç±»å¹¶ä¸”å®ç°è¿™1000ä¸ªæ–¹æ³•ï¼Œè€Œä½¿ç”¨é™æ€ä»£ç†ä½ åˆ™éœ€è¦ç®€å•çš„å‡ è¡Œä»£ç å°±èƒ½å®ç°è¿™ä¸ªé—®é¢˜ã€‚

## JavaåŠ¨æ€ä»£ç†çš„ç®€å•ä½¿ç”¨ ##

### åŠ¨æ€ä»£ç†çš„ç›¸å…³ç±» ###

åŠ¨æ€ä»£ç†ä¸»è¦ä¸¤ä¸ªç›¸å…³ç±»ï¼š

* Proxyï¼ˆjava.lang.reflectåŒ…ä¸‹çš„ï¼‰ï¼Œä¸»è¦è´Ÿè´£ç®¡ç†å’Œåˆ›å»ºä»£ç†ç±»çš„å·¥ä½œã€‚
* InvocationHandler æ¥å£ï¼Œåªæ‹¥æœ‰ä¸€ä¸ªinvokeæ–¹æ³•ï¼Œä¸»è¦è´Ÿè´£æ–¹æ³•è°ƒç”¨éƒ¨åˆ†ï¼Œæ˜¯åŠ¨æ€ä»£ç†ä¸­æˆ‘ä»¬éœ€è¦å®ç°çš„æ–¹æ³•

` public Object invoke (Object proxy, Method method, Object[] args) throws Throwable ; //ä¸‰ä¸ªå‚æ•°åˆ†åˆ«æ˜¯ ä»£ç†ç±»proxy å§”æ‰˜ç±»è¢«æ‰§è¡Œçš„æ–¹æ³•method æ–¹æ³•ä¼ å…¥çš„å‚æ•°args //è¿”å›å€¼åˆ™æ˜¯methodæ–¹æ³•æ‰§è¡Œçš„è¿”å›å€¼ å¤åˆ¶ä»£ç `

ä¸‹é¢æˆ‘ä»¬æ¥ä¸¾ä¸ªå…·ä½“çš„ä½¿ç”¨ä¾‹å­ï¼Œå‡è®¾æœ‰ä¸‹é¢è¿™ä¹ˆä¸€ä¸ªæ¥å£å’Œä¸¤ä¸ªç±»æ¥è´Ÿè´£å¯¹è®¢å•çš„æ“ä½œ

` public interface OrderHandler { void handler (String orderId) ; } public class NormalOrderHandler implements OrderHandler { @Override public void handler (String orderId) { System.out.println( "NormalOrderHandler.handler():orderId:" +orderId); } } public class MaxOrderHandler implements OrderHandler { @Override public void handler (String orderId) { System.out.println( "MaxOrderHandler.handler():orderId:" +orderId); } } å¤åˆ¶ä»£ç `

è€Œè¿™ä¸ªæ—¶å€™è¦æ±‚æˆ‘ä»¬åœ¨æ¯ä¸ªhandleræ–¹æ³•è°ƒç”¨å‰åéƒ½æ‰“å°ä¸€ä¸²ä¿¡æ¯ï¼Œå¹¶ä¸”å½“orderIdçš„é•¿åº¦å¤§äº10æ—¶æˆªå–å‰10ä½ï¼ˆä¸è¦é—®æˆ‘è¿™ç§éœ€æ±‚æ˜¯å“ªä¸ªRZæçš„ï¼Œåæ­£ä¸æ˜¯åšä¸»ï¼Œä½ æ‡‚å¾—ğŸ˜ï¼‰ è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥åšå¦‚ä¸‹ç¼–ç ï¼š

` //åˆ›å»ºä¸€ä¸ªå¤„ç†å™¨ç±»å®ç°InvocationHandleræ¥å£å¹¶å®ç°invokeæ–¹æ³• public class OrderHandlerProxy implements InvocationHandler { //å§”æ‰˜ç±» åœ¨è¿™é‡Œå°±ç›¸å½“äºå®ç°äº†OrderHandlerçš„ç±»çš„å¯¹è±¡ Object target; public Object bind (Object target) { this.target=target; //é‡ç‚¹ä¹‹ä¸€ï¼Œé€šè¿‡Proxyçš„é™æ€æ–¹æ³•åˆ›å»ºä»£ç†ç±» ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºå§”æ‰˜ç±»çš„ç±»åŠ è½½å™¨ï¼Œ //ç¬¬äºŒä¸ªå‚æ•°ä¸ºå§”æ‰˜ç±»å®ç°çš„æ¥å£é›†ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°åˆ™æ˜¯å¤„ç†å™¨ç±»æœ¬èº« return Proxy.newProxyInstance( this.target.getClass().getClassLoader(), this.target.getClass().getInterfaces(), this ); } //é‡ç‚¹ä¹‹äºŒ @Override public Object invoke (Object proxy, Method method, Object[] args) throws Throwable { //åˆ¤æ–­æ‰§è¡Œçš„æ–¹æ³•æ˜¯å¦æ˜¯æˆ‘ä»¬éœ€è¦ä»£ç†çš„handleræ–¹æ³• if (method.getName().equalsIgnoreCase( "handler" )){ System.out.println( "OrderHandlerProxy.invoke.before" ); String orderId= (String) args[ 0 ]; //å¯¹orderIdçš„é•¿åº¦åšé™åˆ¶ if (orderId.length()>= 10 ){ orderId=orderId.substring( 0 , 10 ); } //é‡ç‚¹ä¹‹ä¸‰ï¼Œè¿™ä¸ªåœ°æ–¹é€šè¿‡åå°„è°ƒç”¨å§”æ‰˜ç±»çš„æ–¹æ³• Object invoke = method.invoke(target, orderId); System.out.println( "OrderHandlerProxy.invoke.after" ); return invoke; } else { //å½“å‰æ‰§è¡Œçš„æ–¹æ³•ä¸æ˜¯æˆ‘ä»¬éœ€è¦ä»£ç†çš„æ–¹æ³•æ—¶ä¸åšæ“ä½œç›´æ¥æ‰§è¡Œå§”æ‰˜çš„ç›¸åº”æ–¹æ³• System.out.println( "Method.name:" +method.getName()); return method.invoke(target,args); } } } å¤åˆ¶ä»£ç `

æ¥ä¸‹æ¥åˆ™æ˜¯å…·ä½“çš„ä½¿ç”¨åŠ¨æ€ä»£ç†çš„ä»£ç 

` public class NormalApplicationClass { public void handlerOrder (OrderHandler orderHandler,String orderId) { //åˆ›å»ºå¤„ç†å™¨å¯¹è±¡ OrderHandlerProxy proxy= new OrderHandlerProxy(); //ä¸ºä¼ å…¥çš„å®ç°äº†OrderHandleræ¥å£çš„å¯¹è±¡åˆ›å»ºä»£ç†ç±»å¹¶å®ä¾‹åŒ–å¯¹è±¡ OrderHandler handler = (OrderHandler) proxy.bind(orderHandler); handler.handler(orderId); System.out.println(handler.toString()); } public static void main (String[] args) { NormalApplicationClass app= new NormalApplicationClass(); app.handlerOrder( new MaxOrderHandler(), "012345678999" ); } } å¤åˆ¶ä»£ç `

å…·ä½“çš„è¿”å›å€¼å¦‚ä¸‹

` OrderHandlerProxy.invoke.before MaxOrderHandler.handler():orderId:0123456789 OrderHandlerProxy.invoke.after Method.name:toString com.against.javase.rtti.use.MaxOrderHandler@d716361 å¤åˆ¶ä»£ç `

ç”±ä¸Šé¢å¯è§ï¼Œæˆ‘ä»¬æˆåŠŸçš„åœ¨æ‰§è¡Œhandleræ–¹æ³•å‰åæ‰“å°äº†ä¸€ä¸²ä¸œè¥¿ï¼Œå¹¶ä¸”å¯¹orderIdè¿›è¡Œäº†é•¿åº¦é™åˆ¶ï¼ŒåŒæ—¶å¹¶ä¸ä¼šå½±å“å¯¹è±¡æœ¬èº«çš„åƒtoStringä¹‹ç±»çš„å…¶ä»–æ–¹æ³•è°ƒç”¨é€ æˆå½±å“ã€‚

## åŠ¨æ€ä»£ç†çš„åŸç†è§£è¯» ##

æˆ‘ä»¬çŸ¥é“åŠ¨æ€ä»£ç†å’Œé™æ€ä»£ç†çš„ä¸€å¤§åŒºåˆ«æ— æ³•å°±æ˜¯åˆ›å»ºä»£ç†ç±»çš„è¿‡ç¨‹ä¸ä¸€æ ·ï¼Œè€ŒåŠ¨æ€ä»£ç†ä¸­åˆ›å»ºä»£ç†ç±»çš„æ“ä½œä¸»è¦æ˜¯åœ¨Proxy.newProxyInstance()æ–¹æ³•ä¸­ï¼Œé‚£æˆ‘ä»¬ä¸»è¦æ¥çœ‹ä¸‹è¿™ä¸ªæ–¹æ³•çš„æºç 

` public static Object newProxyInstance (ClassLoader loader, Class<?>[] interfaces, InvocationHandler h) throws IllegalArgumentException { //çœç•¥æ‰éƒ¨åˆ†ä»£ç ï¼Œä¸»è¦æ˜¯ä¸€äº›Jvmå®‰å…¨æ€§çš„éªŒè¯å’Œæƒé™çš„éªŒè¯ /* * è·å–æˆ–è€…ç”Ÿæˆä¸€ä¸ªä»£ç†ç±»çš„Classå¯¹è±¡ã€‚ä¸ºä»€ä¹ˆæ˜¯è·å–æˆ–ç”Ÿæˆå‘¢ï¼Ÿ * è¿™æ˜¯åº”ä¸ºæœ‰ç¼“å­˜æœºåˆ¶çš„å­˜åœ¨ï¼Œ * å½“ç¬¬äºŒæ¬¡è°ƒç”¨newProxyInstanceæ–¹æ³•å¹¶ä¸”ä¸Šæ¬¡ç”Ÿæˆçš„ä»£ç†ç±»çš„ç¼“å­˜è¿˜æœªè¿‡æœŸæ—¶ä¼šç›´æ¥è·å– */ Class<?> cl = getProxyClass0(loader, intfs); /* * é€šè¿‡åå°„è·å–ä»£ç†ç±»çš„æ„é€ å™¨ï¼Œå¹¶é€šè¿‡æ„é€ å™¨ç”Ÿæˆä»£ç†ç±»å¯¹è±¡ */ try { //... //é€šè¿‡åå°„è·å–ä»£ç†ç±»çš„æ„é€ å™¨ï¼Œ final Constructor<?> cons = cl.getConstructor(constructorParams); final InvocationHandler ih = h; if (!Modifier.isPublic(cl.getModifiers())) { AccessController.doPrivileged( new PrivilegedAction<Void>() { public Void run () { cons.setAccessible( true ); return null ; } }); } //é€šè¿‡æ„é€ å™¨ç”Ÿæˆä»£ç†å¯¹è±¡ï¼Œè¿™é‡Œè¿”å›çš„å°±æ˜¯ç»™æˆ‘ä»¬ä½¿ç”¨çš„ä»£ç†ç±»çš„å¯¹è±¡äº† return cons.newInstance( new Object[]{h}); } //....çœç•¥æ‰ä¸€äº›æ— å…³ä»£ç  } å¤åˆ¶ä»£ç `

é€šè¿‡ä¸Šé¢ä»£ç ä¸ç„¶çœ‹å‡ºProxyæ˜¯å…ˆæ‹¿åˆ°ä»£ç†ç±»çš„Classå¯¹è±¡ï¼Œç„¶åé€šè¿‡åå°„è·å–æ„é€ å™¨ï¼Œä»æ„é€ å™¨æ³¨å…¥InvocationHandlerå®ä¾‹ï¼ˆå°±æ˜¯æˆ‘ä»¬è‡ªå·±å®ç°çš„å¤„ç†å™¨ç±»ï¼‰å¹¶åˆ›å»ºä»£ç†ç±»çš„å®ä¾‹ã€‚è€Œè·å–ä»£ç†ç±»çš„Classå¯¹è±¡çš„æ“ä½œåˆ™åœ¨Class<?> cl = getProxyClass0(loader, intfs);è¿™é‡Œï¼Œé‚£ä¹ˆæˆ‘ä»¬ç»§ç»­è·Ÿè¸ªï¼Œå‘ç°é‡Œé¢éå¸¸ç®€å•ï¼Œåªæ˜¯åšäº†ä¸€äº›å¸¸è§„çš„æ£€æŸ¥å¹¶ä¸”è°ƒç”¨äº†proxyClassCache.get(loader, interfaces);ã€‚æˆ‘ä»¬æŸ¥çœ‹å‘ç°

` /** * a cache of proxy classes */ private static final WeakCache<ClassLoader, Class<?>[], Class<?>> proxyClassCache = new WeakCache<>( new KeyFactory(), new ProxyClassFactory()); //çœ‹åˆ°WeakCacheæˆ‘ä»¬å°±èƒ½å¤§æ¦‚çŒœåˆ°è¿™ä¸œè¥¿æ˜¯åšä»€ä¹ˆçš„äº†å§ï¼Ÿè€Œçœ‹ProxyClassFactoryçš„ç±»åæˆ‘ä»¬ä¸éš¾çœ‹å‡ºåˆ›å»ºä»£ç†ç±»çš„Classå¯¹è±¡çš„æ“ä½œéƒ½åœ¨è¿™é‡Œé¢ å¤åˆ¶ä»£ç `

è€Œè¿™ä¸ªç±»é‡Œé¢ä¹Ÿéå¸¸ç®€å•ï¼Œä¸»è¦æ–¹æ³•å°±æ˜¯å…¶ä¸­çš„ applyæ–¹æ³•ã€‚

` @Override public Class<?> apply(ClassLoader loader, Class<?>[] interfaces) { //...å‰é¢ä¸»è¦æ˜¯ä¸€äº›ç”ŸæˆproxyNameï¼Œä»£ç†ç±»ç±»åçš„æ“ä½œï¼Œçœç•¥æ‰ //å…·ä½“çš„ç”Ÿæˆæ“ä½œå°±æ˜¯åœ¨è¿™ä¸ªæ–¹æ³•é‡Œé¢ byte [] proxyClassFile = ProxyGenerator.generateProxyClass( proxyName, interfaces, accessFlags); try { //è¿™ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ªnativeæ–¹æ³•ï¼Œé€šè¿‡ç±»åŠ è½½å™¨å’Œç±»åä»¥åŠç±»çš„æ–‡ä»¶çš„å­—èŠ‚æµæ¥åŠ è½½å‡ºClasså¯¹è±¡ã€‚ return defineClass0(loader, proxyName,proxyClassFile, 0 , proxyClassFile.length); } catch (ClassFormatError e) { throw new IllegalArgumentException(e.toString()); } } å¤åˆ¶ä»£ç `

æ¥ä¸‹æ¥å·²ç»å¯ä»¥å®šä½äº†ç±»çš„ç”Ÿæˆæ“ä½œå°±åœ¨ProxyGenerator.generateProxyClass(proxyName, interfaces, accessFlags);ä¸­ è¿™éƒ¨åˆ†çš„ä»£ç æ¯”è¾ƒç¹æ‚ï¼Œæˆ‘ä»¬åªæ˜¯ç®€å•çš„çœ‹ä¸€ä¸ªåœ°æ–¹ã€‚

` this.addProxyMethod(hashCodeMethod, Object.class); this.addProxyMethod(equalsMethod, Object.class); this.addProxyMethod(toStringMethod, Object.class); //é€šè¿‡è¿™ä¸ªåœ°æ–¹æˆ‘ä»¬çŸ¥é“äº†ï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬å¯¹ä»£ç†ç±»çš„toStringç­‰æ–¹æ³•çš„è°ƒç”¨ä¹Ÿä¼šèµ°ä»£ç†ç±»çš„invokeæ–¹æ³•ï¼Œè¿™æ˜¯åº”ä¸ºåœ¨ç”Ÿæˆå§”æ‰˜ç±»çš„æ—¶å€™å¸®æˆ‘ä»¬é‡å†™äº†è¿™å‡ ä¸ªæ–¹æ³•ã€‚ //ç”Ÿæˆä¸€ä¸ªå¸¦æœ‰InvocationHandlerå‚æ•°çš„æ„é€ å™¨ private ProxyGenerator. MethodInfo generateConstructor () throws IOException { ProxyGenerator.MethodInfo var1 = new ProxyGenerator.MethodInfo( "<init>" , "(Ljava/lang/reflect/InvocationHandler;)V" , 1 ); DataOutputStream var2 = new DataOutputStream(var1.code); this.code_aload( 0 , var2); this.code_aload( 1 , var2); var2.writeByte( 183 ); var2.writeShort( this.cp.getMethodRef( "java/lang/reflect/Proxy" , "<init>" , "(Ljava/lang/reflect/InvocationHandler;)V" )); var2.writeByte( 177 ); var1.maxStack = 10 ; var1.maxLocals = 2 ; var1.declaredExceptions = new short [ 0 ]; return var1; } å¤åˆ¶ä»£ç `

è€Œæ¥ä¸‹æ¥çš„æ“ä½œæ— éæ˜¯æ ¹æ®å§”æ‰˜ç±»å®ç°çš„æ¥å£ï¼Œæ¥ç”Ÿæˆç›¸åº”çš„ä»£ç†æ–¹æ³•ï¼Œå¹¶ä¸”ç”Ÿæˆä¸€ä¸ªéœ€è¦ä¼ é€’InvocationHandlerå¯¹è±¡çš„æ„é€ å™¨ï¼Œåªä¸è¿‡è¿™é‡Œç”Ÿæˆçš„æ˜¯.classæ–‡ä»¶ï¼Œè€Œä¸æ˜¯æˆ‘ä»¬æ‰‹åŠ¨ç¼–å†™çš„.javaæ–‡ä»¶ï¼Œè€Œ.classæ–‡ä»¶æ˜¯å·²ç»ç¼–è¯‘è¿‡çš„æ–‡ä»¶ï¼Œjvmå¯ä»¥ç›´æ¥åŠ è½½è¿›å»æ‰§è¡Œï¼Œçœå»äº†ç¼–è¯‘è¿™ä¸€æ­¥éª¤ã€‚ ä¸‹é¢æˆ‘ä»¬çœ‹çœ‹Proxyä¸ºæˆ‘ä»¬ç”Ÿæˆçš„ä»£ç†ç±»æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼š

` public final class $ Proxy0 extends Proxy implements OrderHandler { private static Method m1; private static Method m2; private static Method m3; private static Method m0; public $Proxy0(InvocationHandler var1) throws { super (var1); } public final boolean equals (Object var1) throws { try { return (Boolean) super.h.invoke( this , m1, new Object[]{var1}); } catch (RuntimeException | Error var3) { throw var3; } catch (Throwable var4) { throw new UndeclaredThrowableException(var4); } } public final String toString () throws { try { return (String) super.h.invoke( this , m2, (Object[]) null ); } catch (RuntimeException | Error var2) { throw var2; } catch (Throwable var3) { throw new UndeclaredThrowableException(var3); } } public final void handler (String var1) throws { try { super.h.invoke( this , m3, new Object[]{var1}); } catch (RuntimeException | Error var3) { throw var3; } catch (Throwable var4) { throw new UndeclaredThrowableException(var4); } } public final int hashCode () throws { try { return (Integer) super.h.invoke( this , m0, (Object[]) null ); } catch (RuntimeException | Error var2) { throw var2; } catch (Throwable var3) { throw new UndeclaredThrowableException(var3); } } static { try { m1 = Class.forName( "java.lang.Object" ).getMethod( "equals" , Class.forName( "java.lang.Object" )); m2 = Class.forName( "java.lang.Object" ).getMethod( "toString" ); m3 = Class.forName( "com.against.javase.rtti.use.OrderHandler" ).getMethod( "handler" , Class.forName( "java.lang.String" )); m0 = Class.forName( "java.lang.Object" ).getMethod( "hashCode" ); } catch (NoSuchMethodException var2) { throw new NoSuchMethodError(var2.getMessage()); } catch (ClassNotFoundException var3) { throw new NoClassDefFoundError(var3.getMessage()); } } } å¤åˆ¶ä»£ç `

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™ä¸ªä»£ç†ç±»æœ¬è´¨ä¸Šæ˜¯å®ç°äº†å§”æ‰˜ç±»çš„æ¥å£ï¼Œå¹¶ä¸”æŠŠæ¯ä¸€ä¸ªå¯¹å§”æ‰˜ç±»å®ç°çš„æ¥å£æ–¹æ³•çš„è°ƒç”¨ä¼ é€’åˆ°æˆ‘ä»¬ç¼–å†™çš„å¤„ç†å™¨ç±»çš„invokeæ–¹æ³•ä¸Šï¼Œä¸€åˆ‡å°±æ¸…æ™°æ˜äº†ï¼ŒåŠ¨æ€ä»£ç†å¹¶ä¸ç¥ç§˜å“ˆå“ˆğŸ˜ã€‚

## åŠ¨æ€ä»£ç†åœ¨Androidä¸­çš„ä½¿ç”¨ ##

> 
> 
> 
> çº¸ä¸Šå¾—æ¥ç»ˆè§‰æµ…ï¼Œç»çŸ¥æ­¤äº‹è¦èº¬è¡Œ
> è¿™å¥è¯è¯´å¾—å¾ˆæœ‰é“ç†ï¼Œåšä¸»åœ¨å­¦ä¹ çš„è¿‡ç¨‹ä¸­æ·±åˆ»æ„Ÿè§‰åˆ°çœ‹ä¸€åƒéä¸å¦‚è‡ªå·±æ¥å†™ä¸€éï¼Œæœ‰äº›çŸ¥è¯†ç‚¹çœ‹ç€æ„Ÿè§‰æ‡‚äº†ï¼Œä¸è‡ªå·±å†™æ ¹æœ¬å‘ç°ä¸äº†ä¸€äº›é—®é¢˜ï¼Œä¸è‡ªå·±å†™ä¹Ÿå¾ˆéš¾æœ‰æ·±åˆ»çš„æ˜ åƒã€‚ç°åœ¨å¤§éƒ¨åˆ†åšå®¢è®²åˆ°åŠ¨æ€ä»£ç†çš„æ—¶å€™éƒ½ä¼šæƒ³æˆ‘ä¸Šé¢çš„ä¸€æ ·ä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­è®²ä¸€ä¸‹ç›¸å…³æ–¹æ³•å°±ç»“æŸäº†ï¼Œè®©äººçœ‹å®Œæ„Ÿè§‰ä»€ä¹ˆéƒ½æ‡‚äº†ï¼Œåˆå¥½åƒä»€ä¹ˆéƒ½æ²¡çœ‹æ‡‚ã€‚
> 
> 
> 

### å®æˆ˜ä¹‹ç®€å•æ¨¡ä»¿butterknifeï¼ˆé»„æ²¹åˆ€ï¼‰çš„åŠŸèƒ½ ###

ï¼ˆå‰æ’æç¤ºé˜…è¯»è¿™éƒ¨åˆ†å†…å®¹éœ€è¦ä¸€äº›åå°„çš„çŸ¥è¯†ï¼‰ åœ¨é€‰æ‹©å…·ä½“çš„ä¾‹å­æ—¶ï¼Œæˆ‘æƒ³äº†ä¸€äº›ä¸œè¥¿ï¼Œæ¯”å¦‚hook SystemManagerï¼Œä½†æ˜¯è¿™éƒ¨åˆ†ç›¸æ¯”è¾ƒäºåŠ¨æ€ä»£ç†çš„ä¸œè¥¿æ›´å¤šçš„è¿˜æ˜¯å’ŒAndroidç³»ç»Ÿå±‚é¢ç›¸å…³çš„ä¸œè¥¿ï¼Œå†™èµ·æ¥ä¹Ÿæ¯”è¾ƒç¹çè€Œä¸”ä¹Ÿå¾ˆéš¾ç”¨å¾ˆå°‘çš„ä»£ç åšå‡ºä¸€äº›æœ‰æ„æ€çš„æ“ä½œã€‚æœ€åæˆ‘æƒ³äº†å†³å®šæ¨¡ä»¿ä¸€ä¸‹é»„æ²¹åˆ€çš„ç®€å•çš„åŠŸèƒ½ï¼Œè¯´èµ·é»„æ²¹åˆ€å¤§å®¶åº”è¯¥éƒ½ä¸é™Œç”Ÿï¼Œä¸‹é¢è¿™ä¸¤ä¸ªæ³¨è§£è‚¯å®šéƒ½ç”¨è¿‡ï¼š

` @BindView () @OnClick () å¤åˆ¶ä»£ç `

ä»Šå¤©æˆ‘ä»¬å°±æ¥å®ç°ä¸‹è¿™ä¸¤ä¸ªæ³¨è§£çš„åŠŸèƒ½ï¼Œä¸‹é¢ç›´æ¥ä¸Šä»£ç  å…ˆå®šä¹‰ä¸¤ä¸ªæ³¨è§£

` @Target (ElementType.FIELD) @Retention (RetentionPolicy.RUNTIME) public @interface InjectView { int value () ; } @Target (ElementType.METHOD) @Retention (RetentionPolicy.RUNTIME) public @interface OnClick { int [] value(); } å¤åˆ¶ä»£ç `

æ¥ç€åœ¨Activityä¸­ä½¿ç”¨è¿™ä¸¤ä¸ªæ³¨è§£

` public class MainActivity extends AppCompatActivity { @InjectView (R.id.tv) private TextView tv; @InjectView (R.id.iv) private ImageView iv; @Override protected void onCreate (Bundle savedInstanceState) { super.onCreate(savedInstanceState); setContentView(R.layout.activity_main); ViewInject.inject( this ); tv.setText( "inject success!" ); iv.setImageDrawable(getResources().getDrawable(R.mipmap.ic_launcher)); } @OnClick ({R.id.tv,R.id.iv}) public void onClick (View view) { switch (view.getId()){ case R.id.tv: Toast.makeText( this , "onClick,TV" ,Toast.LENGTH_SHORT).show(); break ; case R.id.iv: Toast.makeText( this , "onClick,IV" ,Toast.LENGTH_SHORT).show(); break ; } } } å¤åˆ¶ä»£ç `

è¿™éƒ¨åˆ†ä»£ç å¾ˆç®€å•ï¼Œæ²¡æœ‰ä»€ä¹ˆå¥½è¯´çš„ï¼Œé‡ç‚¹åœ¨ViewInject.inject(this);è¿™é‡Œ

` public class ViewInject { public static void inject (Activity activity) { Class<? extends Activity> activityKlazz = activity.getClass(); try { injectView(activity,activityKlazz); proxyClick(activity,activityKlazz); } catch (NoSuchMethodException e) { e.printStackTrace(); } catch (IllegalAccessException e) { e.printStackTrace(); } catch (InvocationTargetException e) { e.printStackTrace(); } } private static void proxyClick (Activity activity,Class<? extends Activity> activityKlazz) throws NoSuchMethodException, InvocationTargetException, IllegalAccessException { Method[] declaredMethods = activityKlazz.getDeclaredMethods(); for (Method declaredMethod : declaredMethods) { //è·å–æ ‡è®°äº†OnClickæ³¨è§£çš„æ–¹æ³• if (declaredMethod.isAnnotationPresent(OnClick.class)){ OnClick annotation = declaredMethod.getAnnotation(OnClick.class); int [] value = annotation.value(); //åˆ›å»ºå¤„ç†å™¨ç±»å¹¶ä¸”ç”Ÿæˆä»£ç†ç±»ï¼ŒåŒæ—¶å°†activityä¸­æˆ‘ä»¬æ ‡è®°äº†OnClickçš„æ–¹æ³•å’Œå¤„ç†å™¨ç±»ç»‘å®šèµ·æ¥ OnClickListenerProxy proxy= new OnClickListenerProxy(); Object listener=proxy.bind(activity); proxy.bindEvent(declaredMethod); for ( int viewId : value) { Method findViewByIdMethod = activityKlazz.getMethod( "findViewById" , int.class); findViewByIdMethod.setAccessible( true ); View view = (View) findViewByIdMethod.invoke(activity, viewId); //é€šè¿‡åå°„æŠŠæˆ‘ä»¬çš„ä»£ç†ç±»æ³¨å…¥åˆ°ç›¸åº”viewçš„onClickListenerä¸­ Method setOnClickListener = view.getClass().getMethod( "setOnClickListener" , View.OnClickListener.class); setOnClickListener.setAccessible( true ); setOnClickListener.invoke(view,listener); } } } } private static void injectView (Activity activity,Class<? extends Activity> activityKlazz) throws NoSuchMethodException, IllegalAccessException, InvocationTargetException { /** * æ³¨å…¥viewå…¶å®å¾ˆç®€å•ï¼Œé€šè¿‡åå°„æ‹¿åˆ°activityä¸­æ ‡è®°äº†InjectViewæ³¨è§£çš„fieldã€‚ * ç„¶åé€šè¿‡åå°„è·å–åˆ°findViewByIdæ–¹æ³•ï¼Œå¹¶ä¸”æ‰§è¡Œè¿™ä¸ªæ–¹æ³•æ‹¿åˆ°viewçš„å®ä¾‹ * æ¥ç€å°†å®ä¾‹èµ‹å€¼ç»™activityé‡Œçš„fieldä¸Š */ for (Field field : activityKlazz.getDeclaredFields()) { if (field.isAnnotationPresent(InjectView.class)) { InjectView annotation = field.getAnnotation(InjectView.class); int viewId = annotation.value(); Method findViewByIdMethod = activityKlazz.getMethod( "findViewById" , int.class); findViewByIdMethod.setAccessible( true ); View view = (View) findViewByIdMethod.invoke(activity, viewId); field.setAccessible( true ); field.set(activity, view); } } } } å¤åˆ¶ä»£ç `

ä¸Šé¢çš„ä»£ç éƒ½æœ‰æ³¨é‡Šï¼Œä¸‹é¢çœ‹ä¸‹OnClickListenerProxyè¿™ä¸ªå¤„ç†å™¨ç±»:

` public class OnClickListenerProxy implements InvocationHandler { static final String TAG= "OnClickListenerProxy" ; //è¿™ä¸ªå…¶å®å°±æ˜¯æˆ‘ä»¬ç›¸å…³çš„activity Object delegate; //è¿™ä¸ªæ˜¯activityä¸­æˆ‘ä»¬æ ‡è®°äº†OnClickçš„æ–¹æ³•ï¼Œæœ€ç»ˆçš„æ“ä½œå°±æ˜¯æŠŠå¯¹OnClickListenerä¸­OnClickæ–¹æ³•çš„è°ƒç”¨æ›¿æ¢æˆå¯¹è¿™ä¸ªeventæ–¹æ³•çš„è°ƒç”¨ Method event; public Object bind (Object delegate) { this.delegate=delegate; //ç”Ÿæˆä»£ç†ç±»ï¼Œè¿™ä¸ªæ²¡ä»€ä¹ˆå¥½è¯´çš„äº† return Proxy.newProxyInstance( this.delegate.getClass().getClassLoader(), new Class[]{View.OnClickListener.class}, this ); } @Override public Object invoke (Object proxy, Method method, Object[] args) throws Throwable { Log.e(TAG, "invoke" ); Log.e(TAG, "method.name:" +method.getName()+ " args:" +args); //åˆ¤æ–­è°ƒç”¨çš„æ˜¯onClickæ–¹æ³•çš„è¯ï¼Œæ›¿æ¢æˆå¯¹æˆ‘ä»¬eventæ–¹æ³•çš„è°ƒç”¨ã€‚ if ( "onClick".equals(method.getName())){ for (Object arg : args) { Log.e(TAG, "arg:" +arg); } View view= (View) args[ 0 ]; return event.invoke(delegate,view); } return method.invoke(delegate,args); } public void bindEvent (Method declaredMethod) { event=declaredMethod; } } å¤åˆ¶ä»£ç `

é€šè¿‡ä¸Šé¢çš„ä»£ç å®ç°ï¼Œæˆ‘ä»¬å·²ç»èƒ½å¤Ÿå°†é¡¹ç›®è¿è¡Œå¹¶ä¸”æˆåŠŸå®ç°äº†æˆ‘ä»¬éœ€è¦çš„åŠŸèƒ½ã€‚å½“ç„¶å¾ˆæœ‰å¾ˆå¤šç»†èŠ‚éœ€è¦å¤„ç†ï¼Œä¸è¿‡ä½œä¸ºå±•ç¤ºå­¦ä¹ å·²ç»è¶³å¤Ÿç”¨äº†ï¼Œè€Œä¸”é€šè¿‡æˆ‘ä»¬è‡ªå·±çš„æ–¹æ³•ä¹Ÿå®ç°äº†é»„æ²¹åˆ€è¿™ç§å¤§åé¼é¼çš„å¼€æºåº“çš„éƒ¨åˆ†åŠŸèƒ½æ˜¯ä¸æ˜¯å¾ˆCoolå‘¢ï¼Ÿ

ä¸è¿‡åšä¸»å¹¶ä¸å»ºè®®å†è‡ªå·±é¡¹ç›®ä¸­ä½¿ç”¨è¿™äº›ï¼Œå¤§å®¶è¿˜æ˜¯ä½¿ç”¨é»„æ²¹åˆ€å§ï¼Œå› ä¸ºåå°„å’ŒåŠ¨æ€ä»£ç†éƒ½ä¼šå¸¦æ¥ä¸€éƒ¨åˆ†çš„æ€§èƒ½æŸè€—ï¼Œè€Œé»„æ²¹åˆ€ä½¿ç”¨çš„æ˜¯ç¼–è¯‘æ—¶æ³¨è§£çš„å½¢å¼å®ç°ä¸Šé¢çš„åŠŸèƒ½çš„ï¼Œåœ¨è¿è¡Œæ—¶ä¸ä¼šå¸¦æ¥æ€§èƒ½çš„æŸè€—ï¼Œæ„Ÿå…´è¶£çš„å°ä¼™ä¼´ä»¬å¯ä»¥å»Googleç›¸å…³çš„æ–‡ç« ã€‚